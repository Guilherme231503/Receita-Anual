<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Relatório Financeiro SK Agency Corps.</title>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- jsPDF AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    font-family: "Arial", sans-serif;
    background: #f4f6f9;
    padding: 40px;
}
.container {
    max-width: 500px;
    background: #fff;
    padding: 30px;
    margin: auto;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
h2 {
    text-align: center;
    margin-bottom: 25px;
    color: #333;
}
input {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    margin-bottom: 20px;
    border-radius: 8px;
    border: 1px solid #ccc;
}
button {
    width: 100%;
    padding: 12px;
    background: #0057d8;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
}
button:hover {
    background: #0041a8;
}
</style>
</head>
<body>

<div class="container">
<h2>Gerador de Relatório Financeiro</h2>

<label>Receita Anual (TZ):</label>
<input type="number" id="valor" placeholder="Ex: 8700000000">

<button onclick="gerarPDF()">Gerar PDF Profissional</button>
</div>

<script>
function gerarID() {
    return Math.floor(Math.random()*899999999999 + 100000000000);
}

function formatTZ(n) {
    return "$TZ " + n.toLocaleString("pt-BR");
}

async function gerarPDF() {
    const { jsPDF } = window.jspdf;
    const valor = parseFloat(document.getElementById("valor").value);

    if(!valor || valor <=0){
        alert("Digite um valor válido.");
        return;
    }

    const dataHoje = new Date().toLocaleDateString("pt-BR");
    const transacaoID = gerarID();
    
    // Divisões
    const distribuicao = [
        {item:"Investimentos", valor:valor*0.25},
        {item:"Vendas Diretas", valor:valor*0.22},
        {item:"Lojas Parceiras", valor:valor*0.18},
        {item:"Pesquisa & Desenvolvimento", valor:valor*0.15},
        {item:"Infraestrutura", valor:valor*0.10},
        {item:"Marketing", valor:valor*0.07},
        {item:"Custos Operacionais", valor:valor*0.03}
    ];

    const pdf = new jsPDF();

    // Cabeçalho
    pdf.setFontSize(20);
    pdf.setTextColor(10,10,60);
    pdf.text("SK Agency Corps.", 20, 20);
    pdf.setFontSize(10);
    pdf.setTextColor(0,0,0);
    pdf.text("CNPJ: 12.345.678/0001-99", 20, 28);
    pdf.text("Data: " + dataHoje, 20, 34);
    pdf.text("ID da Transação: " + transacaoID, 20, 40);
    
    // Receita Total
    pdf.setFontSize(14);
    pdf.text("Receita Total:", 20, 55);
    pdf.setFontSize(12);
    pdf.text(formatTZ(valor), 20, 62);

    // Tabela
    const tableData = distribuicao.map(d => [d.item, formatTZ(d.valor)]);
    pdf.autoTable({
        head:[["Categoria","Valor"]],
        body: tableData,
        startY:75,
        theme:'grid',
        headStyles:{fillColor:[0,87,216],textColor:255}
    });

    // Gráfico em canvas temporário
    const canvas = document.createElement("canvas");
    canvas.width = 300;
    canvas.height = 200;
    const ctx = canvas.getContext("2d");

    const chart = new Chart(ctx,{
        type:"pie",
        data:{
            labels: distribuicao.map(d=>d.item),
            datasets:[{
                data: distribuicao.map(d=>d.valor),
                backgroundColor:[
                    "#0057d8","#0099ff","#00cc99","#ff9933","#ff6666","#9933ff","#999999"
                ]
            }]
        },
        options:{
            plugins:{
                legend:{position:"right",labels:{font:{size:8}}}
            }
        }
    });

    // Espera o gráfico renderizar
// Espera o gráfico finalizar antes de gerar imagem
await new Promise(resolve => {
    chart.options.animation = {
        onComplete: () => resolve()
    };
});

    const imgData = canvas.toDataURL("image/png");
    pdf.addImage(imgData,'PNG',20,120,160,100);

    // Aviso

    pdf.save("Relatorio_SK_Agency_Corps.pdf");
}
</script>

</body>
</html>
