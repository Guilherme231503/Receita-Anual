<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Relatório Financeiro SK Agency Corps.</title>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- jsPDF AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    font-family: "Arial", sans-serif;
    background: #f4f6f9;
    padding: 40px;
}
.container {
    max-width: 500px;
    background: #fff;
    padding: 30px;
    margin: auto;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
h2 {
    text-align: center;
    margin-bottom: 25px;
    color: #333;
}
input {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    margin-bottom: 20px;
    border-radius: 8px;
    border: 1px solid #ccc;
}
button {
    width: 100%;
    padding: 12px;
    background: #0057d8;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
}
button:hover {
    background: #0041a8;
}
    progress {
    height: 20px;
    border-radius: 8px;
    overflow: hidden;
    }
</style>
</head>
<body>

<div class="container">
<h2>Gerador de Relatório Financeiro</h2>

<label>Receita Anual (TZ):</label>
<input type="number" id="valor" placeholder="Ex: 8700000000">
<progress id="barraProgresso" value="0" max="100" style="width:100%; display:none; margin-bottom:20px;"></progress>
<button onclick="gerarPDF()">Gerar PDF Profissional</button>
</div>

<script>
function gerarID() {
    return Math.floor(Math.random()*899999999999 + 100000000000);
}

function formatTZ(n) {
    return "$TZ " + n.toLocaleString("pt-BR");
}
async function gerarPDF() {
    const barra = document.getElementById("barraProgresso");
    barra.style.display = "block";
    barra.value = 0;

    const { jsPDF } = window.jspdf;
    const valor = parseFloat(document.getElementById("valor").value);
    if(!valor || valor <=0){
        alert("Digite um valor válido.");
        barra.style.display = "none";
        return;
    }

    barra.value = 10; // etapa inicial

    const dataHoje = new Date().toLocaleDateString("pt-BR");
    const transacaoID = gerarID();

    // Divisões
    const distribuicao = [
        {item:"Investimentos", valor:valor*0.25},
        {item:"Vendas Diretas", valor:valor*0.22},
        {item:"Lojas Parceiras", valor:valor*0.18},
        {item:"Pesquisa & Desenvolvimento", valor:valor*0.15},
        {item:"Infraestrutura", valor:valor*0.10},
        {item:"Marketing", valor:valor*0.07},
        {item:"Custos Operacionais", valor:valor*0.03}
    ];

    barra.value = 30; // tabela e texto

    const pdf = new jsPDF();
    pdf.setFontSize(20);
    pdf.setTextColor(10,10,60);
    pdf.text("SK Agency Corps.", 20, 20);
    pdf.setFontSize(10);
    pdf.setTextColor(0,0,0);
    pdf.text("CNPJ: 12.345.678/0001-99", 20, 28);
    pdf.text("Data: " + dataHoje, 20, 34);
    pdf.text("ID da Transação: " + transacaoID, 20, 40);
    pdf.setFontSize(14);
    pdf.text("Receita Total:", 20, 55);
    pdf.setFontSize(12);
    pdf.text(formatTZ(valor), 20, 62);

    barra.value = 50; // tabela

    const tableData = distribuicao.map(d => [d.item, formatTZ(d.valor)]);
    pdf.autoTable({
        head:[["Categoria","Valor"]],
        body: tableData,
        startY:75,
        theme:'grid',
        headStyles:{fillColor:[0,87,216],textColor:255}
    });

    barra.value = 70; // gráfico

    // Gráfico
    const canvas = document.createElement("canvas");
    canvas.width = 300;
    canvas.height = 200;
    const ctx = canvas.getContext("2d");

    const chart = new Chart(ctx,{
        type:"pie",
        data:{
            labels: distribuicao.map(d=>d.item),
            datasets:[{
                data: distribuicao.map(d=>d.valor),
                backgroundColor:[
                    "#0057d8","#0099ff","#00cc99","#ff9933","#ff6666","#9933ff","#999999"
                ]
            }]
        },
        options:{
            animation: {
                duration: 1000, // 1s de animação
                onProgress: (anim) => {
                    barra.value = 70 + anim.currentStep/anim.numSteps * 20;
                },
                onComplete: () => {
                    barra.value = 90;
                }
            },
            plugins:{legend:{position:"right",labels:{font:{size:8}}}}
        }
    });

    // espera o gráfico renderizar
    await new Promise(resolve => {
        chart.options.animation.onComplete = resolve;
    });

    const imgData = canvas.toDataURL("image/png");
    pdf.addImage(imgData,'PNG',20,120,160,100);

    barra.value = 100; // finalizado
    pdf.save("Relatorio_SK_Agency_Corps.pdf");
    barra.style.display = "none"; // esconde barra
}

</script>

</body>
</html>
